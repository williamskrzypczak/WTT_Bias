//@version=5
indicator("WTT_Bias R1.24", "WTT_Bias R1.24", overlay=true)

// ============================================================================
// Copyright © 2025 Bulldog Ventures Inc. All rights reserved.
//
// WaveRider Trading Technologies
// 
// REVISION HISTORY:
// R1.24 - Enhanced visual aesthetics
//        - Incorporated revision number into indicator name
//        - Histogram uses darker colors for stronger bias and lighter colors for weaker bias
//        - Strong bias bars: dark green (bullish) / dark gray (bearish)
//        - Weak bias bars: light green (bullish) / light gray (bearish)
//        - Zero-cross markers use triangle shapes (up/down) in small size
//        - Added Histogram Intensity Multiplier input parameter
//        - Renamed Triangle Color to Zero-Cross Marker Color for clarity
//        - Signal line now uses lime/reddish-pink colors for quick recognition
//        - Added intensity decrease dots on signal line (dots appear when bias moves from stronger to weaker)
//        - Triangle markers set to small size for clear visibility
// R1.23 - Marigold orange triangles
//        - Added Triangle Color (default Marigold #FFBF00) and applied to markers
// R1.22 - Alerts include symbol
//        - Added currency pair (symbol) to alert messages
// R1.21 - Yellow triangles for zero-cross
//        - Triangles now use Zero Color (yellow)
// R1.20 - Restored triangle markers on histogram
//        - Replaced text 0^/0v labels with triangle shapes at bias value
// R1.19 - Default: Histogram ON
//        - Enabled bias histogram by default
// R1.18 - Configurable zero-cross text size
//        - Added "Zero Text Size" setting (Tiny–Huge)
// R1.17 - Text-only zero-cross markers
//        - Replaced triangle shapes with yellow text labels (0^ / 0v)
// R1.16 - Reliable, de-duplicated alerts
//        - Added option to alert on bar close (default)
//        - Ensure one alert per bar; prioritize zero-cross events
// R1.15 - Yellow text for 0↑/0↓ markers
//        - Added configurable Zero Text Color (default yellow)
// R1.14 - Yellow zero bars in histogram
//        - Added configurable Zero Color (default yellow)
// R1.13 - Triangles on price chart; histogram off by default
//        - Switched to overlay on main price chart
//        - Disabled histogram/signal line by default to show only markers
// R1.12 - Added zero-cross chart markers
//        - Optional triangles on price chart when bias crosses zero
//        - Toggle via "Show Zero-Cross Markers" in Visual Settings
// R1.11 - Changed default table setting
//        - Set default for "Show Info Table" to false (off)
//        - Users can enable table display if desired
//        - Cleaner default appearance
// R1.10 - Updated bearish color
//        - Changed bearish color from purple to gray
//        - Maintains teal for bullish and gray for bearish/neutral
// R1.9 - Updated histogram colors
//       - Changed bullish color from green to teal
//       - Changed bearish color from red to purple
//       - Maintains neutral gray color
// R1.8 - Changed default lower timeframe
//       - Changed default lower timeframe from 1 minute to 30 minutes
//       - Updated tooltip to reflect new default
//       - Better default for most chart timeframes
// R1.7 - Made table more compact
//       - Abbreviated metric descriptions for better space efficiency
//       - "Upticks / Downticks" → "Up/Down Ticks"
//       - "Buy Volume / Sell Volume" → "Buy/Sell Vol"
//       - "Measurement Mode" → "Mode"
//       - "Smoothed Bias" → "Bias"
// R1.6 - Enhanced table color scheme
//       - Changed value column text color to blue for better contrast
//       - Keeps colored text for bias value (green/red/gray)
//       - Maintains white text for metric labels
// R1.5 - Improved table readability
//       - Changed metric column text color to white for better visibility
//       - Maintains black text for values and colored text for bias
// R1.4 - Fixed table display issue
//       - Table now recreates on each update to show metric labels
//       - Fixed issue where metric labels weren't displaying
//       - Table properly shows all data including labels
// R1.3 - Improved table metric descriptions
//       - Updated metric labels for better clarity
//       - Changed "Ticks (Up/Down)" to "Upticks / Downticks"
//       - Changed "Volume (Buy/Sell)" to "Buy Volume / Sell Volume"
//       - Changed "Bias Mode" to "Measurement Mode"
//       - Changed "Bias (S) [-1..1]" to "Smoothed Bias"
// R1.2 - Fixed info table data display
//       - Table now properly shows upticks/downticks and volume data
//       - Uses real-time data for live bar, LTF data for historical bars
//       - All table fields now populate correctly
// R1.1 - Enabled real-time info table
//       - Uncommented and activated info table display
//       - Shows upticks/downticks count in real-time
//       - Displays buy/sell volume, bias mode, and smoothed bias value
// R1.0 - Initial release - Intrabar bid/ask bias (proxy)
//       - Real-time uptick/downtick counting with volume deltas
//       - Normalized bias oscillator (-1 to +1)
//       - Optional info table and alerts
//
// This indicator approximates buy/sell (bid/ask) activity within the current
// bar by classifying real-time close changes as upticks/downticks and
// distributing the current bar's volume changes accordingly. Due to Pine
// Script's lack of true order book access, this measures a proxy, not actual
// bid/ask prints.
// ============================================================================

// ============================================================================
// INPUT PARAMETERS
// ============================================================================
// Group: Detection Settings
biasMode = input.string(
     defval="Volume",
     title="Bias Mode",
     options=["Volume", "Ticks"],
     group="Detection Settings",
     tooltip="How to measure bias: Volume uses realtime volume deltas per uptick/downtick; Ticks counts upticks vs downticks.")

sourceMode = input.string(
     defval="Auto (Realtime+History)",
     title="Source Mode",
     options=["Auto (Realtime+History)", "Realtime only", "Lower TF only"],
     group="Detection Settings",
     tooltip="Auto: realtime proxy on the last (live) bar, lower timeframe aggregation on historical bars. Realtime only: realtime proxy on live bar, lower TF on historical bars. Lower TF only: always use lower timeframe aggregation.")

lowerTf = input.timeframe(
     defval="30",
     title="Lower Timeframe (for history)",
     group="Detection Settings",
     tooltip="Timeframe used to approximate intrabar buy/sell on historical bars. Set lower than your chart TF (e.g., 30 minutes).")

neutralDeadband = input.float(
     defval=0.05,
     title="Neutral Deadband",
     minval=0.0, maxval=0.5, step=0.01,
     group="Detection Settings",
     tooltip="Bias within ±deadband is treated as neutral to suppress minor noise.")

smoothLength = input.int(
     defval=3,
     title="Smoothing Length",
     minval=1, maxval=100,
     group="Detection Settings",
     tooltip="Simple moving average length applied to the bias after deadband.")

alertThreshold = input.float(
     defval=0.20,
     title="Alert Threshold",
     minval=0.0, maxval=1.0, step=0.01,
     group="Detection Settings",
     tooltip="Trigger alerts when smoothed bias crosses above +threshold or below -threshold.")

// Group: Visual Settings
showHistogram = input.bool(
     defval=true,
     title="Show Bias Histogram",
     group="Visual Settings",
     tooltip="Show bias as a histogram from -1 to +1.")

showSignalLine = input.bool(
     defval=false,
     title="Show Signal Line",
     group="Visual Settings",
     tooltip="Plot the smoothed bias as a line over the histogram.")

showInfoTable = input.bool(
     defval=false,
     title="Show Info Table (last bar)",
     group="Visual Settings",
     tooltip="Display a compact table with upticks/downticks and buy/sell volume on the last bar.")

showZeroCrossMarkers = input.bool(
     defval=true,
     title="Show Zero-Cross Markers",
     group="Visual Settings",
     tooltip="Plot chart markers when the bias crosses the zero line.")

showIntensityDecreaseDots = input.bool(
     defval=true,
     title="Show Intensity Decrease Dots",
     group="Visual Settings",
     tooltip="Plot dots on signal line when bias intensity decreases (stronger to weaker).")

zeroTextSizeOption = input.string(
     defval="Normal",
     title="Zero Text Size",
     options=["Tiny", "Small", "Normal", "Large", "Huge"],
     group="Visual Settings",
     tooltip="Controls the font size of the 0^ / 0v labels on the chart.")

// Group: Alert Settings
alertOnBarClose = input.bool(
     defval=true,
     title="Alerts on Bar Close (More Reliable)",
     group="Alert Settings",
     tooltip="When enabled, alerts trigger once per bar at close using the final values, reducing missed triggers.")

// Group: Colors
bullishColor = input.color(
     defval=color.new(color.teal, 0),
     title="Bullish Color",
     group="Colors")

bearishColor = input.color(
     defval=color.new(color.gray, 0),
     title="Bearish Color",
     group="Colors")

neutralColor = input.color(
     defval=color.new(color.gray, 0),
     title="Neutral Color",
     group="Colors")

zeroColor = input.color(
     defval=color.new(color.yellow, 0),
     title="Zero Color",
     group="Colors")

zeroTextColor = input.color(
     defval=color.new(color.yellow, 0),
     title="Zero Text Color",
     group="Colors")

markerColor = input.color(
     defval=color.new(color.rgb(255, 191, 0), 0),
     title="Zero-Cross Marker Color (Marigold)",
     group="Colors",
     tooltip="Color for diamond markers that appear when bias crosses zero.")

histTransparency = input.int(
     defval=10,
     title="Histogram Transparency (0-100)",
     minval=0, maxval=100,
     group="Colors")

lineTransparency = input.int(
     defval=0,
     title="Line Transparency (0-100)",
     minval=0, maxval=100,
     group="Colors")

intensityMultiplier = input.int(
     defval=60,
     title="Histogram Intensity Multiplier",
     minval=0, maxval=100,
     group="Colors",
     tooltip="Controls how much transparency varies with bias strength. Higher values = stronger bias becomes more opaque. Lower values = subtle effect.")

// ============================================================================
// CALCULATIONS - REALTIME PROXY (LAST BAR)
// ============================================================================
// State variables for intrabar counting
var int upTickCount = 0
var int downTickCount = 0
var float buyVolume = 0.0
var float sellVolume = 0.0
var float lastCloseRt = na
var float lastVolumeRt = na

// Reset counters at the start of each new bar
if barstate.isnew
    upTickCount := 0
    downTickCount := 0
    buyVolume := 0.0
    sellVolume := 0.0
    lastCloseRt := close
    lastVolumeRt := volume

// On each realtime update of current bar, classify uptick/downtick and allocate volume delta
if barstate.isrealtime
    priceDelta = close - nz(lastCloseRt, close)
    volumeDelta = math.max(volume - nz(lastVolumeRt, volume), 0)
    isUpTick = priceDelta > 0
    isDownTick = priceDelta < 0

    if isUpTick
        upTickCount := upTickCount + 1
        buyVolume := buyVolume + volumeDelta
    else if isDownTick
        downTickCount := downTickCount + 1
        sellVolume := sellVolume + volumeDelta
    else
        // No price change: evenly apportion any volume delta
        buyVolume := buyVolume + volumeDelta * 0.5
        sellVolume := sellVolume + volumeDelta * 0.5

    lastCloseRt := close
    lastVolumeRt := volume

// Realtime raw biases
rtTickTotal = upTickCount + downTickCount
rtTickBiasRaw = rtTickTotal > 0 ? (upTickCount - downTickCount) / rtTickTotal : 0.0
rtVolTotal = buyVolume + sellVolume
rtVolBiasRaw = rtVolTotal > 0 ? (buyVolume - sellVolume) / rtVolTotal : 0.0

// ============================================================================
// CALCULATIONS - LOWER TIMEFRAME AGGREGATION (HISTORICAL & OPTIONAL LIVE)
// ============================================================================
// Helper functions evaluated in lower timeframe context
calcLtfBuyAgg() =>
    barBuy = close > close[1] ? volume : close < close[1] ? 0.0 : volume * 0.5
    cumBuy = ta.cum(barBuy)
    newHtfBar = ta.change(time(timeframe.period))
    startCum = nz(ta.valuewhen(newHtfBar, cumBuy[1], 0), 0.0)
    cumBuy - startCum

calcLtfSellAgg() =>
    barSell = close < close[1] ? volume : close > close[1] ? 0.0 : volume * 0.5
    cumSell = ta.cum(barSell)
    newHtfBar = ta.change(time(timeframe.period))
    startCum = nz(ta.valuewhen(newHtfBar, cumSell[1], 0), 0.0)
    cumSell - startCum

calcLtfUpAgg() =>
    barUp = close > close[1] ? 1.0 : 0.0
    cumUp = ta.cum(barUp)
    newHtfBar = ta.change(time(timeframe.period))
    startCum = nz(ta.valuewhen(newHtfBar, cumUp[1], 0), 0.0)
    cumUp - startCum

calcLtfDownAgg() =>
    barDown = close < close[1] ? 1.0 : 0.0
    cumDown = ta.cum(barDown)
    newHtfBar = ta.change(time(timeframe.period))
    startCum = nz(ta.valuewhen(newHtfBar, cumDown[1], 0), 0.0)
    cumDown - startCum

// Inside the lower timeframe, classify each LTF bar by tick rule and accumulate within the current chart TF bar boundaries.
ltfBuyAgg = request.security(syminfo.tickerid, lowerTf, calcLtfBuyAgg(), barmerge.gaps_off, barmerge.lookahead_off)
ltfSellAgg = request.security(syminfo.tickerid, lowerTf, calcLtfSellAgg(), barmerge.gaps_off, barmerge.lookahead_off)

// LTF ticks approximation: count up/down bars at the lower timeframe
ltfUpAgg = request.security(syminfo.tickerid, lowerTf, calcLtfUpAgg(), barmerge.gaps_off, barmerge.lookahead_off)
ltfDownAgg = request.security(syminfo.tickerid, lowerTf, calcLtfDownAgg(), barmerge.gaps_off, barmerge.lookahead_off)

ltfVolTotal = ltfBuyAgg + ltfSellAgg
ltfVolBiasRaw = ltfVolTotal > 0 ? (ltfBuyAgg - ltfSellAgg) / ltfVolTotal : 0.0
ltfTickTotal = ltfUpAgg + ltfDownAgg
ltfTickBiasRaw = ltfTickTotal > 0 ? (ltfUpAgg - ltfDownAgg) / ltfTickTotal : 0.0

// ============================================================================
// CALCULATIONS - SELECTED SOURCE AND MODE
// ============================================================================
useRealtime = (sourceMode == "Realtime only" and barstate.isrealtime) or (sourceMode == "Auto (Realtime+History)" and barstate.isrealtime)

rawBias = biasMode == "Volume"
     ? (useRealtime ? rtVolBiasRaw : ltfVolBiasRaw)
     : (useRealtime ? rtTickBiasRaw : ltfTickBiasRaw)

// Apply deadband
applyDeadband(val, db) => math.abs(val) < db ? 0.0 : val
biased = applyDeadband(rawBias, neutralDeadband)

// Smooth
smoothedBias = ta.sma(biased, smoothLength)

// Visual colors
biasColor = smoothedBias > 0 ? bullishColor : smoothedBias < 0 ? bearishColor : neutralColor

// Calculate bias intensity for dynamic color darkness
// Stronger bias = darker colors (less transparency = darker/more solid)
// Weaker bias = lighter colors (more transparency = lighter/more faded)
biasIntensity = math.abs(smoothedBias)

// Calculate transparency based on bias strength
// Strong bias (near ±1.0) → low transparency (dark green/gray)
// Weak bias (near 0) → high transparency (light green/gray)
// Formula: darkness increases with bias strength
// Maximum lightness for weakest bias (high transparency ~55-60)
// Minimum lightness for strongest bias (low transparency ~0-10)
maxLightness = 60  // Maximum transparency for weakest bias (reduced for more intensity)
effectiveTransparency = smoothedBias == 0 ? histTransparency : 
          math.max(0, math.min(100, maxLightness * (1 - biasIntensity)))

// Get base color for histogram
histogramBaseColor = smoothedBias == 0 ? zeroColor : (smoothedBias > 0 ? bullishColor : bearishColor)
histogramColor = color.new(histogramBaseColor, effectiveTransparency)

// ============================================================================
// VISUAL ELEMENTS
// ============================================================================
hZero = hline(0.0, "Zero Line", color=color.new(color.gray, 60))
plot(showHistogram ? smoothedBias : na, "Bias", style=plot.style_columns,
     color=smoothedBias == 0 ? color.new(zeroColor, effectiveTransparency) : histogramColor)
// Signal line with lime/reddish-pink for quick directional recognition
signalLineColor = smoothedBias > 0 ? color.new(color.rgb(191, 255, 0), lineTransparency) :  // Lime
                  smoothedBias < 0 ? color.new(color.rgb(255, 100, 140), lineTransparency) :  // Reddish-pink
                  color.new(color.gray, lineTransparency)
plot(showSignalLine ? smoothedBias : na, "Signal", color=signalLineColor, linewidth=2)

// Detect when bias intensity decreases (stronger to weaker)
previousBiasIntensity = math.abs(smoothedBias[1])
currentBiasIntensity = math.abs(smoothedBias)
intensityDecreased = currentBiasIntensity < previousBiasIntensity and not na(previousBiasIntensity)

// Plot dot on signal line when intensity decreases
plotshape(showSignalLine and showIntensityDecreaseDots and intensityDecreased ? smoothedBias : na,
     title="Intensity Decrease Dot",
     style=shape.circle,
     location=location.absolute,
     color=signalLineColor,
     size=size.tiny)

// Zero-cross visual markers will be plotted after zero-cross detection

// ============================================================================
// TABLE (REAL-TIME DATA)
// ============================================================================
var table biasInfoTable = na
if showInfoTable and barstate.islast
    // Delete existing table to recreate with updated data
    if not na(biasInfoTable)
        table.delete(biasInfoTable)
    
    // Create new table
    biasInfoTable := table.new(position.top_right, 2, 5, bgcolor=color.new(color.white, 95), border_width=2)
    
    // Header
    table.cell(biasInfoTable, 0, 0, "Metric", bgcolor=color.gray, text_color=color.white)
    table.cell(biasInfoTable, 1, 0, "Value",  bgcolor=color.gray, text_color=color.white)

    // Get current bar data (use real-time if available, otherwise LTF data)
    currentUpTicks = barstate.isrealtime ? upTickCount : ltfUpAgg
    currentDownTicks = barstate.isrealtime ? downTickCount : ltfDownAgg
    currentBuyVol = barstate.isrealtime ? buyVolume : ltfBuyAgg
    currentSellVol = barstate.isrealtime ? sellVolume : ltfSellAgg

    // Rows
    table.cell(biasInfoTable, 0, 1, "Up/Down Ticks", text_color=color.white)
    table.cell(biasInfoTable, 1, 1, str.tostring(currentUpTicks) + " / " + str.tostring(currentDownTicks), text_color=color.blue)

    table.cell(biasInfoTable, 0, 2, "Buy/Sell Vol", text_color=color.white)
    volText = str.tostring(currentBuyVol, "#.##") + " / " + str.tostring(currentSellVol, "#.##")
    table.cell(biasInfoTable, 1, 2, volText, text_color=color.blue)

    table.cell(biasInfoTable, 0, 3, "Mode", text_color=color.white)
    table.cell(biasInfoTable, 1, 3, biasMode, text_color=color.blue)

    table.cell(biasInfoTable, 0, 4, "Bias", text_color=color.white)
    table.cell(biasInfoTable, 1, 4, str.tostring(smoothedBias, "#.###"), text_color=biasColor)

// =========================================================================
// ALERTS
// =========================================================================
turnedBullish = ta.crossover(smoothedBias, alertThreshold)
turnedBearish = ta.crossunder(smoothedBias, -alertThreshold)
flippedBull = ta.crossover(smoothedBias, 0.0)
flippedBear = ta.crossunder(smoothedBias, 0.0)

// Zero-cross visual markers (triangle shapes at bias level on histogram)
bullFlipSignal = showZeroCrossMarkers and flippedBull
bearFlipSignal = showZeroCrossMarkers and flippedBear

plotshape(bullFlipSignal ? smoothedBias : na, title="Zero-Cross Up",
     style=shape.triangleup, location=location.absolute,
     color=markerColor, size=size.small)

plotshape(bearFlipSignal ? smoothedBias : na, title="Zero-Cross Down",
     style=shape.triangledown, location=location.absolute,
     color=markerColor, size=size.small)

// Emit at most one alert per bar with priority: zero-cross > threshold
shouldEvaluateNow = alertOnBarClose ? barstate.isconfirmed : barstate.isconfirmed or barstate.isrealtime
if shouldEvaluateNow
    string alertMsg = na
    if flippedBull
        alertMsg := "WTT_Bias (" + syminfo.ticker + "): Bias flipped above 0"
    else if flippedBear
        alertMsg := "WTT_Bias (" + syminfo.ticker + "): Bias flipped below 0"
    else if turnedBullish
        alertMsg := "WTT_Bias (" + syminfo.ticker + "): Bias crossed above +" + str.tostring(alertThreshold)
    else if turnedBearish
        alertMsg := "WTT_Bias (" + syminfo.ticker + "): Bias crossed below -" + str.tostring(alertThreshold)

    if not na(alertMsg)
        alert(alertMsg, alertOnBarClose ? alert.freq_once_per_bar_close : alert.freq_once_per_bar)

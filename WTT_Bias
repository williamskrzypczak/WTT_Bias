//@version=5
indicator("WTT_Bias R1.43", "WTT_Bias R1.43", overlay=false)

// ============================================================================
// Copyright © 2025 Bulldog Ventures Inc. All rights reserved.
//
// WaveRider Trading Technologies
// 
// REVISION HISTORY:
// R1.43 - Fixed compression alert direction accuracy on intrabar reversals
//        - Fixed issue where compression alerts could fire twice on same bar with incorrect direction
//        - Added prioritization logic when both bullish and bearish breakouts occur simultaneously
//        - Prioritizes based on current close position relative to doji range (above high = bull, below low = bear)
//        - Resets opposite alert flag on direction reversal to allow correct alerts within same bar
//        - Prevents duplicate alerts when both conditions are true by only allowing prioritized direction
// R1.42 - Enhanced compression alerts with explicit direction indicators
//        - Added "UP direction" and "DOWN direction" labels to compression alert messages
//        - Makes breakout direction immediately clear in alert notifications
//        - Applies to both bullish and bearish compression breakout alerts
// R1.41 - Matched compression breakout triangle size to intensity decrease dots
//        - Changed triangle markers from size.large to size.small to match dot size
//        - Ensures visual consistency between compression markers and intensity dots
//        - Applies to both bullish (up) and bearish (down) compression breakout markers
// R1.40 - Increased compression breakout triangle marker size
//        - Changed triangle markers from size.tiny to size.large for better visibility
//        - Applies to both bullish (up) and bearish (down) compression breakout markers
// R1.39 - Enhanced bias table with intensity decrease indicator
//        - Added "DECREASING" indicator to bias table when intensity is decreasing
//        - Decreasing indicator displayed in separate cell with smaller font (tiny size)
//        - Decreasing cell background and text use signal line colors (lime green/reddish-pink)
//        - Text color automatically contrasts with background for optimal readability
//        - Visual consistency with intensity decrease dots on signal line
// R1.38 - Added bias table display at lower right corner with intensity visualization
//        - Added compact bias table showing current bias direction and intensity
//        - Table displays text labels: "LONG", "SHORT", or "NEUTRAL" instead of numerical values
//        - Added intensity labels: "STRONG", "MODERATE", or "WEAK" appended to direction
//        - Table uses color-coded backgrounds matching histogram colors (green/reddish-pink/yellow)
//        - Enhanced visual intensity: stronger bias = more opaque colors, weaker = more transparent
//        - Reduced background transparency for better visibility (40% base, up to 35% intensity variation)
//        - Added toggle input parameter to show/hide table
//        - Table updates only on last bar for optimal performance
// R1.37 - Removed VU meter table and cleaned up unused code
//        - Removed VU meter table and all related code
//        - Removed unused previousEvaluatedBias variable
//        - Code cleanup and optimization
// R1.36 - Enhanced compression alerts and removed bias meter table
//        - Modified compression breakout detection to use doji open/close instead of high/low
//        - Added minimum breakout percentage threshold (default 0.2%) to reduce false triggers
//        - Aligned compression alerts with dot plotting conditions for consistency
//        - Removed bias meter table and all related code
// R1.35 - Removed combined signal feature and cleaned up code
//        - Removed combined signal visual indicators and related debug/test markers
//        - Removed combined signal alert functionality
//        - Code cleanup and optimization
// R1.33 - Enhanced histogram visual aesthetics
//        - Improved color gradient transitions with smoother exponential interpolation
//        - Added histogram style selection (Columns/Area/Both) for visual customization
// R1.32 - Removed zero-cross visual markers and pip value calculations
//        - Removed zero-cross marker input parameter and visual markers
//        - Removed zero-cross marker color input parameter
//        - Removed zero-cross triangle logic from bias meter table
//        - Removed all pip value calculation code (added in R1.30)
//        - Removed pip value settings input group
//        - Simplified bias meter table to 3 rows (removed pip value row)
// R1.31 - Code cleanup and color/transparency improvements
//        - Removed unused alertThreshold input parameter (removed in R1.29)
//        - Removed unused neutralColor input parameter
//        - Simplified redundant centerActive logic in bias meter
//        - Removed redundant zeroCrossBull/zeroCrossBear variable assignments
//        - Removed unnecessary segmentIndex calculation
//        - Fixed histogram transparency to respect histTransparency setting for all bias values
//        - Changed bullish color from teal to lime green (RGB 50, 205, 50)
//        - Changed bearish color from gray to white-ish (RGB 230, 230, 230)
//        - Increased default histogram transparency from 10 to 35
// R1.29 - Streamlined alerts to focus on intensity and compression
//        - Removed zero-cross alerts (bias flipping above/below 0)
//        - Removed threshold alerts (bias crossing ±threshold)
//        - Kept intensity decrease alerts (bias momentum easing)
//        - Kept compression breakout alerts (doji breakouts)
//        - Visual markers and calculations remain unchanged
// R1.28 - Integrated WTT Compression doji breakout detection
//        - Added doji compression detection with configurable body threshold
//        - Added bullish/bearish breakout markers on price chart
//        - Added optional alerts for compression breakouts
//        - Changed overlay back to true to support price chart markers
// R1.27 - Updated lower timeframe default to 5 minutes for faster historical bias sampling
// R1.26 - Updated lower timeframe default to 10 minutes for finer historical bias resolution
// R1.25 - Enhanced bias meter table and improved reliability
//        - Added "Directional Bias" title row to bias meter table
//        - Changed "SHORTS" to "SHORT" and "LONGS" to "LONG" for cleaner labels
//        - Changed neutral marker from "N" to "NEUTRAL" for clarity
//        - Changed center cell background to lower intensity yellow (75% transparency)
//        - Changed center cell text color to black for better contrast against yellow background
//        - Reduced title text size to small for more compact table display
//        - Added robust state reset mechanism using bar_index as fallback when barstate.isnew fails
//        - This prevents histogram update issues after extended chart sessions
// R1.24 - Enhanced visual aesthetics with analog bias meter
//        - Incorporated revision number into indicator name
//        - Histogram uses darker colors for stronger bias and lighter colors for weaker bias
//        - Zero-cross markers use triangle shapes (up/down) in small size
//        - Renamed Triangle Color to Zero-Cross Marker Color for clarity
//        - Signal line uses lime/reddish-pink colors for quick recognition
//        - Added intensity decrease dots on signal line (dots appear when bias moves from stronger to weaker)
//        - Replaced info table with analog bias meter dial (bottom-right position)
//        - Meter displays bias with 5 segments: 2 shorts (left), 1 center, 2 longs (right)
//        - Red/green gradient in meter matches histogram intensity (uses current and previous bar)
//        - Up/down arrows in center cell show current bias direction
//        - Zero-cross triangles (▲/▼) appear in center cell when bias crosses zero
//        - Marker colors in center cell match histogram dot colors (lime/reddish-pink)
//        - Code cleanup: Removed unused variables and input parameters
// R1.23 - Marigold orange triangles
//        - Added Triangle Color (default Marigold #FFBF00) and applied to markers
// R1.22 - Alerts include symbol
//        - Added currency pair (symbol) to alert messages
// R1.21 - Yellow triangles for zero-cross
//        - Triangles now use Zero Color (yellow)
// R1.20 - Restored triangle markers on histogram
//        - Replaced text 0^/0v labels with triangle shapes at bias value
// R1.19 - Default: Histogram ON
//        - Enabled bias histogram by default
// R1.18 - Configurable zero-cross text size
//        - Added "Zero Text Size" setting (Tiny–Huge)
// R1.17 - Text-only zero-cross markers
//        - Replaced triangle shapes with yellow text labels (0^ / 0v)
// R1.16 - Reliable, de-duplicated alerts
//        - Added option to alert on bar close (default)
//        - Ensure one alert per bar; prioritize zero-cross events
// R1.15 - Yellow text for 0↑/0↓ markers
//        - Added configurable Zero Text Color (default yellow)
// R1.14 - Yellow zero bars in histogram
//        - Added configurable Zero Color (default yellow)
// R1.13 - Triangles on price chart; histogram off by default
//        - Switched to overlay on main price chart
//        - Disabled histogram/signal line by default to show only markers
// R1.12 - Added zero-cross chart markers
//        - Optional triangles on price chart when bias crosses zero
//        - Toggle via "Show Zero-Cross Markers" in Visual Settings
// R1.11 - Changed default table setting
//        - Set default for "Show Info Table" to false (off)
//        - Users can enable table display if desired
//        - Cleaner default appearance
// R1.10 - Updated bearish color
//        - Changed bearish color from purple to gray
//        - Maintains teal for bullish and gray for bearish/neutral
// R1.9 - Updated histogram colors
//       - Changed bullish color from green to teal
//       - Changed bearish color from red to purple
//       - Maintains neutral gray color
// R1.8 - Changed default lower timeframe
//       - Changed default lower timeframe from 1 minute to 30 minutes
//       - Updated tooltip to reflect new default
//       - Better default for most chart timeframes
// R1.7 - Made table more compact
//       - Abbreviated metric descriptions for better space efficiency
//       - "Upticks / Downticks" → "Up/Down Ticks"
//       - "Buy Volume / Sell Volume" → "Buy/Sell Vol"
//       - "Measurement Mode" → "Mode"
//       - "Smoothed Bias" → "Bias"
// R1.6 - Enhanced table color scheme
//       - Changed value column text color to blue for better contrast
//       - Keeps colored text for bias value (green/red/gray)
//       - Maintains white text for metric labels
// R1.5 - Improved table readability
//       - Changed metric column text color to white for better visibility
//       - Maintains black text for values and colored text for bias
// R1.4 - Fixed table display issue
//       - Table now recreates on each update to show metric labels
//       - Fixed issue where metric labels weren't displaying
//       - Table properly shows all data including labels
// R1.3 - Improved table metric descriptions
//       - Updated metric labels for better clarity
//       - Changed "Ticks (Up/Down)" to "Upticks / Downticks"
//       - Changed "Volume (Buy/Sell)" to "Buy Volume / Sell Volume"
//       - Changed "Bias Mode" to "Measurement Mode"
//       - Changed "Bias (S) [-1..1]" to "Smoothed Bias"
// R1.2 - Fixed info table data display
//       - Table now properly shows upticks/downticks and volume data
//       - Uses real-time data for live bar, LTF data for historical bars
//       - All table fields now populate correctly
// R1.1 - Enabled real-time info table
//       - Uncommented and activated info table display
//       - Shows upticks/downticks count in real-time
//       - Displays buy/sell volume, bias mode, and smoothed bias value
// R1.0 - Initial release - Intrabar bid/ask bias (proxy)
//       - Real-time uptick/downtick counting with volume deltas
//       - Normalized bias oscillator (-1 to +1)
//       - Optional info table and alerts
//
// This indicator combines two powerful tools:
// 1. Bias Detection: Approximates buy/sell (bid/ask) activity within the current
//    bar by classifying real-time close changes as upticks/downticks and
//    distributing the current bar's volume changes accordingly. Due to Pine
//    Script's lack of true order book access, this measures a proxy, not actual
//    bid/ask prints.
// 2. Compression Detection: Highlights potential breakout momentum that follows
//    indecision candles (dojis). When a doji appears, the script waits for the
//    next bar to close beyond the doji's range and surfaces that breakout
//    direction with markers on the price chart.
// ============================================================================

// ============================================================================
// INPUT PARAMETERS
// ============================================================================
// Group: Detection Settings
biasMode = input.string(
     defval="Volume",
     title="Bias Mode",
     options=["Volume", "Ticks"],
     group="Detection Settings",
     tooltip="How to measure bias: Volume uses realtime volume deltas per uptick/downtick; Ticks counts upticks vs downticks.")

sourceMode = input.string(
     defval="Auto (Realtime+History)",
     title="Source Mode",
     options=["Auto (Realtime+History)", "Realtime only", "Lower TF only"],
     group="Detection Settings",
     tooltip="Auto: realtime proxy on the last (live) bar, lower timeframe aggregation on historical bars. Realtime only: realtime proxy on live bar, lower TF on historical bars. Lower TF only: always use lower timeframe aggregation.")

lowerTf = input.timeframe(
     defval="5",
     title="Lower Timeframe (for history)",
     group="Detection Settings",
     tooltip="Timeframe used to approximate intrabar buy/sell on historical bars. Set lower than your chart TF (e.g., 30 minutes).")

neutralDeadband = input.float(
     defval=0.05,
     title="Neutral Deadband",
     minval=0.0, maxval=0.5, step=0.01,
     group="Detection Settings",
     tooltip="Bias within ±deadband is treated as neutral to suppress minor noise.")

smoothLength = input.int(
     defval=3,
     title="Smoothing Length",
     minval=1, maxval=100,
     group="Detection Settings",
     tooltip="Simple moving average length applied to the bias after deadband.")

intensityAlertEnabled = input.bool(defval=true, title="Alert When Bias Intensity Weakens", group="Detection Settings", tooltip="Send an alert when the signal line dot appears, indicating bullish or bearish momentum is easing.")

// Group: Visual Settings
showHistogram = input.bool(
     defval=true,
     title="Show Bias Histogram",
     group="Visual Settings",
     tooltip="Show bias as a histogram from -1 to +1.")

showSignalLine = input.bool(
     defval=true,
     title="Show Signal Line",
     group="Visual Settings",
     tooltip="Plot the smoothed bias as a line over the histogram.")

showIntensityDecreaseDots = input.bool(
     defval=true,
     title="Show Intensity Decrease Dots",
     group="Visual Settings",
     tooltip="Plot dots on signal line when bias intensity decreases (stronger to weaker).")

histogramStyle = input.string(
     defval="Columns",
     title="Histogram Style",
     options=["Columns", "Area", "Both"],
     group="Visual Settings",
     tooltip="Display style for histogram: Columns (bar-style), Area (continuous fill), or Both (layered effect).")

showBiasTable = input.bool(
     defval=true,
     title="Show Bias Table",
     group="Visual Settings",
     tooltip="Display current bias value in a color-coded table at the lower right corner of the chart.")

// Group: Alert Settings
alertOnBarClose = input.bool(
     defval=true,
     title="Alerts on Bar Close (More Reliable)",
     group="Alert Settings",
     tooltip="When enabled, alerts trigger once per bar at close using the final values, reducing missed triggers.")

// Group: Colors
bullishColor = input.color(
     defval=color.new(color.rgb(50, 205, 50), 0),
     title="Bullish Color",
     group="Colors")

bearishColor = input.color(
     defval=color.new(color.rgb(218, 37, 96), 0),
     title="Bearish Color",
     group="Colors")

zeroColor = input.color(
     defval=color.new(color.yellow, 0),
     title="Zero Color",
     group="Colors")

histTransparency = input.int(
     defval=35,
     title="Histogram Transparency (0-100)",
     minval=0, maxval=100,
     group="Colors")

lineTransparency = input.int(
     defval=0,
     title="Line Transparency (0-100)",
     minval=0, maxval=100,
     group="Colors")

// Group: Compression Settings
dojiBodyPercent = input.float(0.15, "Doji Body Threshold", minval=0.0, maxval=0.5, step=0.01, group="Compression Settings", tooltip="Maximum body-to-range ratio (0.15 = body <= 15% of total range) for a candle to qualify as a doji.")
requireCloseBreak = input.bool(false, "Require Close Breakout", group="Compression Settings", tooltip="When enabled, the breakout candle must close beyond the doji high/low. Disable to react on intrabar breaches.")
confirmOnBarClose = input.bool(false, "Confirm Breakouts On Close", group="Compression Settings", tooltip="Wait for the bar to close before confirming breakout signals. Disable to allow intrabar alerts/markers that may disappear if price reverses.")
breakoutMinPercent = input.float(0.2, "Minimum Breakout %", minval=0.0, maxval=10.0, step=0.1, group="Compression Settings", tooltip="Minimum percentage move from doji open/close required to trigger breakout alert. Higher values reduce false signals from small price movements.")
showCompressionMarkers = input.bool(true, "Show Breakout Markers", group="Compression Settings", tooltip="Toggle display of the breakout triangles.")
compressionUpColor = input.color(color.new(color.orange, 0), "Compression Uptrend Color", group="Compression Settings", tooltip="Marker color for bullish doji breakouts.")
defaultPurple = color.rgb(128, 0, 255)
compressionDownColor = input.color(color.new(defaultPurple, 0), "Compression Downtrend Color", group="Compression Settings", tooltip="Marker color for bearish doji breakouts.")
enableCompressionAlerts = input.bool(true, "Enable Compression Alerts", group="Compression Settings", tooltip="Send an alert notification whenever a bullish or bearish doji breakout is detected.")

// ============================================================================
// CALCULATIONS - REALTIME PROXY (LAST BAR)
// ============================================================================
// State variables for intrabar counting
var int upTickCount = 0
var int downTickCount = 0
var float buyVolume = 0.0
var float sellVolume = 0.0
// State variables for compression alerts (track if we've already alerted for current breakout)
var bool bullBreakoutAlerted = false
var bool bearBreakoutAlerted = false
var float lastCloseRt = na
var float lastVolumeRt = na
var int lastBarIndex = na
var float lastEvaluatedBias = na

// Robust reset: check both barstate.isnew and bar_index change for reliability
// This handles cases where barstate detection might fail after extended sessions
isNewBar = barstate.isnew or (not na(lastBarIndex) and bar_index != lastBarIndex)
if isNewBar
    upTickCount := 0
    downTickCount := 0
    buyVolume := 0.0
    sellVolume := 0.0
    lastCloseRt := close
    lastVolumeRt := volume
    lastBarIndex := bar_index

// On each realtime update of current bar, classify uptick/downtick and allocate volume delta
if barstate.isrealtime
    priceDelta = close - nz(lastCloseRt, close)
    volumeDelta = math.max(volume - nz(lastVolumeRt, volume), 0)
    isUpTick = priceDelta > 0
    isDownTick = priceDelta < 0

    if isUpTick
        upTickCount := upTickCount + 1
        buyVolume := buyVolume + volumeDelta
    else if isDownTick
        downTickCount := downTickCount + 1
        sellVolume := sellVolume + volumeDelta
    else
        // No price change: evenly apportion any volume delta
        buyVolume := buyVolume + volumeDelta * 0.5
        sellVolume := sellVolume + volumeDelta * 0.5

    lastCloseRt := close
    lastVolumeRt := volume

// Realtime raw biases
rtTickTotal = upTickCount + downTickCount
rtTickBiasRaw = rtTickTotal > 0 ? (upTickCount - downTickCount) / rtTickTotal : 0.0
rtVolTotal = buyVolume + sellVolume
rtVolBiasRaw = rtVolTotal > 0 ? (buyVolume - sellVolume) / rtVolTotal : 0.0

// ============================================================================
// CALCULATIONS - LOWER TIMEFRAME AGGREGATION (HISTORICAL & OPTIONAL LIVE)
// ============================================================================
// Helper functions evaluated in lower timeframe context
calcLtfBuyAgg() =>
    barBuy = close > close[1] ? volume : close < close[1] ? 0.0 : volume * 0.5
    cumBuy = ta.cum(barBuy)
    newHtfBar = ta.change(time(timeframe.period)) != 0
    startCum = nz(ta.valuewhen(newHtfBar, cumBuy[1], 0), 0.0)
    cumBuy - startCum

calcLtfSellAgg() =>
    barSell = close < close[1] ? volume : close > close[1] ? 0.0 : volume * 0.5
    cumSell = ta.cum(barSell)
    newHtfBar = ta.change(time(timeframe.period)) != 0
    startCum = nz(ta.valuewhen(newHtfBar, cumSell[1], 0), 0.0)
    cumSell - startCum

calcLtfUpAgg() =>
    barUp = close > close[1] ? 1.0 : 0.0
    cumUp = ta.cum(barUp)
    newHtfBar = ta.change(time(timeframe.period)) != 0
    startCum = nz(ta.valuewhen(newHtfBar, cumUp[1], 0), 0.0)
    cumUp - startCum

calcLtfDownAgg() =>
    barDown = close < close[1] ? 1.0 : 0.0
    cumDown = ta.cum(barDown)
    newHtfBar = ta.change(time(timeframe.period)) != 0
    startCum = nz(ta.valuewhen(newHtfBar, cumDown[1], 0), 0.0)
    cumDown - startCum

// Inside the lower timeframe, classify each LTF bar by tick rule and accumulate within the current chart TF bar boundaries.
ltfBuyAgg = request.security(syminfo.tickerid, lowerTf, calcLtfBuyAgg(), barmerge.gaps_off, barmerge.lookahead_off)
ltfSellAgg = request.security(syminfo.tickerid, lowerTf, calcLtfSellAgg(), barmerge.gaps_off, barmerge.lookahead_off)

// LTF ticks approximation: count up/down bars at the lower timeframe
ltfUpAgg = request.security(syminfo.tickerid, lowerTf, calcLtfUpAgg(), barmerge.gaps_off, barmerge.lookahead_off)
ltfDownAgg = request.security(syminfo.tickerid, lowerTf, calcLtfDownAgg(), barmerge.gaps_off, barmerge.lookahead_off)

ltfVolTotal = ltfBuyAgg + ltfSellAgg
ltfVolBiasRaw = ltfVolTotal > 0 ? (ltfBuyAgg - ltfSellAgg) / ltfVolTotal : 0.0
ltfTickTotal = ltfUpAgg + ltfDownAgg
ltfTickBiasRaw = ltfTickTotal > 0 ? (ltfUpAgg - ltfDownAgg) / ltfTickTotal : 0.0

// ============================================================================
// CALCULATIONS - SELECTED SOURCE AND MODE
// ============================================================================
useRealtime = (sourceMode == "Realtime only" and barstate.isrealtime) or (sourceMode == "Auto (Realtime+History)" and barstate.isrealtime)

rawBias = biasMode == "Volume"
     ? (useRealtime ? rtVolBiasRaw : ltfVolBiasRaw)
     : (useRealtime ? rtTickBiasRaw : ltfTickBiasRaw)

// Apply deadband
applyDeadband(val, db) => math.abs(val) < db ? 0.0 : val
biased = applyDeadband(rawBias, neutralDeadband)

// Smooth
smoothedBias = ta.sma(biased, smoothLength)

// Calculate bias intensity for dynamic color darkness
// Stronger bias = darker colors (less transparency = darker/more solid)
// Weaker bias = lighter colors (more transparency = lighter/more faded)
biasIntensity = math.abs(smoothedBias)

// Calculate transparency based on bias strength using smooth exponential interpolation
// Strong bias (near ±1.0) → low transparency (dark green/gray)
// Weak bias (near 0) → high transparency (light green/gray)
// Formula: Exponential curve for smoother, more natural gradient transitions
// Base transparency from user setting, with intensity-based variation
// Maximum transparency range: histTransparency (strong) to histTransparency + 50 (weak)
maxLightnessRange = 50  // Additional transparency range for intensity variation
gradientExponent = 0.7  // Exponential curve factor for smooth transitions (0.7 provides balanced curve)
// Use exponential interpolation for smoother gradient: pow(biasIntensity, exponent) creates natural curve
effectiveTransparency = smoothedBias == 0 ? histTransparency : 
          math.max(0, math.min(100, histTransparency + (maxLightnessRange * (1 - math.pow(biasIntensity, gradientExponent)))))

// Get base color for histogram
histogramBaseColor = smoothedBias == 0 ? zeroColor : (smoothedBias > 0 ? bullishColor : bearishColor)
histogramColor = color.new(histogramBaseColor, effectiveTransparency)

// ============================================================================
// CALCULATIONS - COMPRESSION (DOJI BREAKOUT)
// ============================================================================
hasValidRange = not na(high) and not na(low) and high != low
trueRange = hasValidRange ? high - low : na
bodySize = not na(close) and not na(open) ? math.abs(close - open) : na
isDoji = hasValidRange and not na(bodySize) and not na(trueRange) and trueRange > 0 and bodySize <= trueRange * dojiBodyPercent
hasPriorBar = bar_index > 0
wasDoji = hasPriorBar and nz(isDoji[1], false)
hasPriorOpenClose = hasPriorBar and not na(open[1]) and not na(close[1])
// Calculate reference prices from doji (higher for bullish, lower for bearish)
dojiHighRef = hasPriorOpenClose ? math.max(open[1], close[1]) : na
dojiLowRef = hasPriorOpenClose ? math.min(open[1], close[1]) : na
// Calculate current price based on requireCloseBreak setting
currentHighPrice = requireCloseBreak ? close : high
currentLowPrice = requireCloseBreak ? close : low
// Calculate percentage moves from reference prices
bullMovePercent = hasPriorOpenClose and dojiHighRef > 0 ? ((currentHighPrice - dojiHighRef) / dojiHighRef) * 100 : 0.0
bearMovePercent = hasPriorOpenClose and dojiLowRef > 0 ? ((dojiLowRef - currentLowPrice) / dojiLowRef) * 100 : 0.0
// Breakout conditions: must break above/below AND exceed minimum percentage threshold
closeBreaksUp = hasPriorOpenClose and (currentHighPrice > dojiHighRef) and (bullMovePercent >= breakoutMinPercent)
closeBreaksDown = hasPriorOpenClose and (currentLowPrice < dojiLowRef) and (bearMovePercent >= breakoutMinPercent)
isBullBreakout = wasDoji and closeBreaksUp
isBearBreakout = wasDoji and closeBreaksDown
isBarConfirmed = not confirmOnBarClose or barstate.isconfirmed
isBullCompressionSignal = isBullBreakout and isBarConfirmed
isBearCompressionSignal = isBearBreakout and isBarConfirmed
bullCompressionAlertMessage = "WaveRider WTT Compression: UP direction - Bullish doji breakout on " + syminfo.ticker + " at " + str.tostring(close, format.mintick)
bearCompressionAlertMessage = "WaveRider WTT Compression: DOWN direction - Bearish doji breakout on " + syminfo.ticker + " at " + str.tostring(close, format.mintick)

// ============================================================================
// VISUAL ELEMENTS
// ============================================================================
hZero = hline(0.0, "Zero Line", color=color.new(color.gray, 60))

// Histogram plots based on style selection
histogramColorFinal = smoothedBias == 0 ? color.new(zeroColor, effectiveTransparency) : histogramColor
showColumns = showHistogram and (histogramStyle == "Columns" or histogramStyle == "Both")
showArea = showHistogram and (histogramStyle == "Area" or histogramStyle == "Both")
// Area style uses slightly higher transparency for layered effect when Both is selected
areaTransparency = histogramStyle == "Both" ? effectiveTransparency + 15 : effectiveTransparency
histogramColorArea = smoothedBias == 0 ? color.new(zeroColor, areaTransparency) : color.new(histogramBaseColor, areaTransparency)

plot(showColumns ? smoothedBias : na, "Bias Columns", style=plot.style_columns, color=histogramColorFinal)
plot(showArea ? smoothedBias : na, "Bias Area", style=plot.style_area, color=histogramColorArea)

// Signal line with lime, reddish-pink, or gray for quick directional recognition
signalLineColor = smoothedBias > 0 ? color.new(color.rgb(191, 255, 0), lineTransparency) : smoothedBias < 0 ? color.new(color.rgb(255, 100, 140), lineTransparency) : color.new(color.gray, lineTransparency)
plot(showSignalLine ? smoothedBias : na, "Signal", color=signalLineColor, linewidth=2)

// Detect when bias intensity decreases (stronger to weaker)
previousBiasIntensity = math.abs(smoothedBias[1])
currentBiasIntensity = math.abs(smoothedBias)
intensityDecreased = currentBiasIntensity < previousBiasIntensity and not na(previousBiasIntensity)
intensityDirection = smoothedBias > 0 ? "bullish" : smoothedBias < 0 ? "bearish" : "neutral"
intensityDescription = intensityDirection == "neutral" ? "Neutral bias momentum compressing" : intensityDirection == "bullish" ? "Bullish momentum easing" : "Bearish momentum easing"

// Plot dot on signal line when intensity decreases (exclude neutral/zero cross gray dots)
plotshape(showSignalLine and showIntensityDecreaseDots and intensityDecreased and intensityDirection != "neutral" ? smoothedBias : na, title="Intensity Decrease Dot", style=shape.circle, location=location.absolute, color=signalLineColor, size=size.small)

// ============================================================================
// BIAS TABLE
// ============================================================================
// Determine bias direction and intensity for table color coding
biasValue = smoothedBias
isBullish = biasValue > 0
isBearish = biasValue < 0
isNeutral = biasValue == 0 or math.abs(biasValue) < neutralDeadband

// Calculate intensity-based transparency for table background
// Stronger bias = more opaque (lower transparency), weaker bias = more transparent
// Base transparency: 40 (vibrant, visible background), with dramatic intensity variation
tableBaseTransparency = 40
tableIntensityVariation = 35  // Increased range for more dramatic intensity visualization
tableTransparency = isNeutral ? tableBaseTransparency : math.max(0, math.min(100, tableBaseTransparency - (biasIntensity * tableIntensityVariation)))

// Determine table background and text colors
tableBgColor = isNeutral ? color.new(zeroColor, tableTransparency) : (isBullish ? color.new(bullishColor, tableTransparency) : color.new(bearishColor, tableTransparency))

tableTextColor = isNeutral ? color.black : color.white

// Determine bias intensity level for labeling
isStrongBias = biasIntensity >= 0.7
isModerateBias = biasIntensity >= 0.3 and biasIntensity < 0.7
isWeakBias = biasIntensity < 0.3 and not isNeutral

// Determine bias direction and intensity text label
biasLabel = isNeutral ? "NEUTRAL" : (isBullish ? "LONG" : "SHORT")
intensityLabel = isStrongBias ? " (STRONG)" : (isModerateBias ? " (MODERATE)" : (isWeakBias ? " (WEAK)" : ""))
// Main label without decreasing indicator
mainBiasLabel = biasLabel + intensityLabel
// Decreasing indicator text (separate for smaller font)
decreasingText = intensityDecreased and intensityDirection != "neutral" ? "DECREASING" : ""

// Calculate contrasting text color for decreasing cell based on signal line color brightness
// Base colors without transparency for luminance calculation
bullishBaseColor = color.rgb(191, 255, 0)  // Lime green
bearishBaseColor = color.rgb(255, 100, 140)  // Reddish-pink
neutralBaseColor = color.gray

// Calculate relative luminance (0-255 scale, higher = brighter)
// Formula: L = 0.299*R + 0.587*G + 0.114*B
bullishLuminance = 0.299 * 191 + 0.587 * 255 + 0.114 * 0  // ~207 (bright - use black text)
bearishLuminance = 0.299 * 255 + 0.587 * 100 + 0.114 * 140  // ~151 (medium - use black text)
neutralLuminance = 128  // Gray - use black text

// Choose text color: black for bright backgrounds (>128), white for dark backgrounds
decreasingTextColor = isNeutral ? color.black : (isBullish ? (bullishLuminance > 128 ? color.black : color.white) : (bearishLuminance > 128 ? color.black : color.white))

// Create and update bias table (only on last bar for performance)
var table biasTable = na

if showBiasTable and barstate.islast
    if na(biasTable)
        biasTable := table.new(position.bottom_right, 3, 2, 
                               bgcolor=color.new(color.white, 95), 
                               border_width=1)
    
    // Header row
    table.cell(biasTable, 0, 0, "Bias", 
               bgcolor=color.new(color.gray, 70), 
               text_color=color.white, 
               text_size=size.small)
    table.cell(biasTable, 1, 0, "", 
               bgcolor=color.new(color.gray, 70))
    table.cell(biasTable, 2, 0, "", 
               bgcolor=color.new(color.gray, 70))
    
    // Value row with color-coded background
    table.cell(biasTable, 0, 1, "", bgcolor=tableBgColor)
    table.cell(biasTable, 1, 1, mainBiasLabel, 
               bgcolor=tableBgColor, 
               text_color=tableTextColor, 
               text_size=size.normal)
    table.cell(biasTable, 2, 1, decreasingText, 
               bgcolor=signalLineColor, 
               text_color=decreasingTextColor, 
               text_size=size.tiny)
else if not showBiasTable and not na(biasTable)
    // Delete table when disabled
    table.delete(biasTable)
    biasTable := na

// Compression breakout markers on price chart
plotshape(showCompressionMarkers and isBullCompressionSignal, title="Doji Breakout Up", style=shape.triangleup, location=location.belowbar, size=size.small, color=compressionUpColor)
plotshape(showCompressionMarkers and isBearCompressionSignal, title="Doji Breakout Down", style=shape.triangledown, location=location.abovebar, size=size.small, color=compressionDownColor)

// =========================================================================
// ALERTS
// =========================================================================
// Emit intensity alert when bias intensity decreases (exclude neutral bias)
// Alert conditions must match dot plotting conditions for consistency
shouldEvaluateNow = alertOnBarClose ? barstate.isconfirmed : barstate.isconfirmed or barstate.isrealtime
if shouldEvaluateNow
    if intensityAlertEnabled and showIntensityDecreaseDots and intensityDecreased and intensityDirection != "neutral"
        alertMsg = "WTT_Bias (" + syminfo.ticker + "): " + intensityDescription
        alert(alertMsg, alertOnBarClose ? alert.freq_once_per_bar_close : alert.freq_once_per_bar)

    lastEvaluatedBias := smoothedBias

// Compression breakout alerts - fire once per bar (intrabar if confirmOnBarClose is false, on close if true)
// Reset alert flags on new bar
if barstate.isnew
    bullBreakoutAlerted := false
    bearBreakoutAlerted := false

// Fire alert once per bar when breakout is detected (prevents TradingView's 15 alerts per 3 minutes limit)
// Alert timing respects confirmOnBarClose setting: false = intrabar, true = on bar close
// When both directions are true simultaneously (price moved through entire doji range), prioritize based on current close position
// If close is above doji high, prioritize bull; if below doji low, prioritize bear; otherwise use stronger percentage move
// When one direction alerts (and not both are true), reset the opposite flag to allow direction reversal within the same bar
bothBreakoutsTrue = isBullCompressionSignal and isBearCompressionSignal
closeAboveDojiHigh = hasPriorOpenClose and close > dojiHighRef
closeBelowDojiLow = hasPriorOpenClose and close < dojiLowRef
prioritizeBull = bothBreakoutsTrue and (closeAboveDojiHigh or (not closeBelowDojiLow and bullMovePercent >= bearMovePercent))
prioritizeBear = bothBreakoutsTrue and (closeBelowDojiLow or (not closeAboveDojiHigh and bearMovePercent > bullMovePercent))

if enableCompressionAlerts and isBullCompressionSignal and not bullBreakoutAlerted and (not bothBreakoutsTrue or prioritizeBull)
    alert(bullCompressionAlertMessage, alert.freq_once_per_bar)
    bullBreakoutAlerted := true
    // Only reset opposite flag if not both breakouts are true (prevents both alerts from firing when both conditions are true)
    if not bothBreakoutsTrue
        bearBreakoutAlerted := false  // Reset opposite flag to allow reversal

if enableCompressionAlerts and isBearCompressionSignal and not bearBreakoutAlerted and (not bothBreakoutsTrue or prioritizeBear)
    alert(bearCompressionAlertMessage, alert.freq_once_per_bar)
    bearBreakoutAlerted := true
    // Only reset opposite flag if not both breakouts are true (prevents both alerts from firing when both conditions are true)
    if not bothBreakoutsTrue
        bullBreakoutAlerted := false  // Reset opposite flag to allow reversal
